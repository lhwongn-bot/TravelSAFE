<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Save List (with GitHub Cloud Auto Sync)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f9;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .form-container,
        .controls, 
        .cloud-sync {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .form-container input, .form-container select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .form-container button, .controls button, .cloud-sync button {
            background-color: #007bff;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 5px;
        }
        .form-container button:hover,
        .controls button:hover,
        .cloud-sync button:hover {
            background-color: #0056b3;
        }
        .cloud-sync input[type="password"] {
            width: 250px;
            margin-right: 10px;
        }
        .filter-container {
            margin-bottom: 20px;
        }
        .filter-container select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        th:hover {
            background-color: #0056b3;
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .actions button {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .actions button:hover {
            background: #c82333;
        }
        .save-btn {
            background-color: #007bff;
            color: white;
        }
        .clear-btn {
            background-color: #6c757d;
            color: white;
        }
        .clear-btn:hover {
            background-color: #5a6268;
        }
        .note {
            color: #888;
            font-size: 0.95em;
            margin-bottom: 10px;
        }
        @media (max-width: 600px) {
            .form-container, .controls, .cloud-sync {
                padding: 10px;
            }
            th, td {
                padding: 6px;
            }
        }
    </style>
</head>
<body>
    <h1>Travel Save List üåç</h1>
    <div class="note">
        <b>Cloud Sync:</b> Enter your GitHub Personal Access Token to sync your list with your repo.<br>
        <b>Token is stored in memory only and never uploaded or saved to disk.</b> <br>
        <a href="https://github.com/settings/tokens" target="_blank">Generate a GitHub token</a> with <code>public_repo</code> scope.<br>
        <b>For your personal use only!</b>
    </div>
    <div class="cloud-sync">
        <label for="githubToken">GitHub Token:</label>
        <input type="password" id="githubToken" placeholder="Paste your GitHub PAT here" autocomplete="off">
        <button onclick="setToken()">Set Token</button>
        <button onclick="removeToken()">Remove Token</button>
        <span id="cloudStatus" class="note"></span>
    </div>

    <div class="form-container">
        <select id="continent" required>
            <option value="" disabled selected>Select Continent</option>
            <option value="Africa">Africa</option>
            <option value="Asia">Asia</option>
            <option value="Australia">Australia</option>
            <option value="Europe">Europe</option>
            <option value="North America">North America</option>
            <option value="South America">South America</option>
        </select>
        <input type="text" id="country" placeholder="Country" required>
        <input type="text" id="location" placeholder="Location" required>
        <input type="text" id="famous" placeholder="Famous Shop/Store/Food" required>
        <input type="url" id="links" placeholder="Links (e.g., https://example.com)">
        <button onclick="addEntry()">Add Destination</button>
    </div>
    <div class="filter-container">
        <select id="countryFilter" onchange="filterByCountry()">
            <option value="">All Countries</option>
        </select>
    </div>
    <table id="travelTable">
        <thead>
            <tr>
                <th onclick="sortTable(0, 'checkbox')">Completed</th>
                <th onclick="sortTable(1, 'text')">Continent</th>
                <th onclick="sortTable(2, 'text')">Country</th>
                <th onclick="sortTable(3, 'text')">Location</th>
                <th onclick="sortTable(4, 'text')">Famous Shop/Store/Food</th>
                <th>Links</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="travelTableBody"></tbody>
    </table>
    <div class="controls">
        <button class="clear-btn" onclick="clearTimetable()">Clear Local</button>
        <button class="save-btn" onclick="exportToFile()">Export</button>
        <button class="save-btn" onclick="document.getElementById('importFile').click()">Import</button>
        <input type="file" id="importFile" style="display:none" accept=".json" onchange="importFromFile(event)">
    </div>

    <script>
        // ---- Cloud Sync Variables ----
        const githubUsername = "lhwongn-bot";
        const githubRepo = "TravelSAFE";
        const githubFilePath = "travel-save-list.json";
        let githubToken = "";
        let lastGitHubSha = null; // for update operations

        // ---- Cloud Sync Token Management ----
        function setToken() {
            githubToken = document.getElementById('githubToken').value.trim();
            if (githubToken) {
                document.getElementById('cloudStatus').textContent = "Token set in memory. Loading from GitHub...";
                autoLoadFromGitHub();
            } else {
                document.getElementById('cloudStatus').textContent = "No token set!";
            }
        }
        function removeToken() {
            githubToken = "";
            document.getElementById('githubToken').value = "";
            document.getElementById('cloudStatus').textContent = "Token cleared from memory.";
        }
        function setStatus(msg) {
            document.getElementById('cloudStatus').textContent = msg;
        }

        // ---- Cloud Sync Functions ----
        async function autoLoadFromGitHub() {
            setStatus("Loading from GitHub...");
            if (!githubToken) { setStatus("Token required!"); return; }
            const url = `https://api.github.com/repos/${githubUsername}/${githubRepo}/contents/${githubFilePath}`;
            try {
                const response = await fetch(url, {
                    headers: { "Authorization": `token ${githubToken}` }
                });
                if (!response.ok) { 
                    setStatus("No data from GitHub yet. Start adding destinations!");
                    originalData = [];
                    renderTable(originalData);
                    updateCountryFilter();
                    return; 
                }
                const data = await response.json();
                lastGitHubSha = data.sha;
                const content = atob(data.content.replace(/\n/g, ""));
                localStorage.setItem('travelSaveList', content);
                originalData = JSON.parse(content || "[]");
                renderTable(originalData);
                updateCountryFilter();
                setStatus("Loaded from GitHub!");
            } catch (e) {
                setStatus("Failed to load from GitHub.");
            }
        }
        async function autoSaveToGitHub() {
            if (!githubToken) return;
            setStatus("Saving to GitHub...");
            const url = `https://api.github.com/repos/${githubUsername}/${githubRepo}/contents/${githubFilePath}`;
            // Try to get the latest SHA if we don't have it
            if (!lastGitHubSha) {
                try {
                    const response = await fetch(url, {
                        headers: { "Authorization": `token ${githubToken}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        lastGitHubSha = data.sha;
                    }
                } catch (e) {}
            }
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(originalData || [], null, 2))));
            const result = await fetch(url, {
                method: "PUT",
                headers: {
                    "Authorization": `token ${githubToken}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    message: "Auto-sync TravelSAFE list",
                    content: content,
                    ...(lastGitHubSha ? { sha: lastGitHubSha } : {})
                })
            });
            if (result.ok) {
                const data = await result.json();
                lastGitHubSha = data.content.sha;
                setStatus("Auto-saved to GitHub!");
            } else {
                setStatus("Failed to save to GitHub.");
            }
        }

        // ---- Local App ----
        let sortDirection = {};
        let originalData = [];

        document.addEventListener('DOMContentLoaded', () => {
            // Only auto-load if the user already set a token this session
            if (githubToken) {
                autoLoadFromGitHub();
            } else {
                // fallback: load from local
                loadTimetable();
                updateCountryFilter();
            }
        });

        function addEntry() {
            const continent = document.getElementById('continent').value;
            const country = document.getElementById('country').value;
            const location = document.getElementById('location').value;
            const famous = document.getElementById('famous').value;
            const links = document.getElementById('links').value;

            if (!continent || !country || !location || !famous) {
                alert('Please fill in all required fields.');
                return;
            }

            const entry = {
                completed: false,
                continent,
                country,
                location,
                famous,
                links: links || ''
            };
            originalData.push(entry);
            renderTable(originalData);
            saveTimetable(); // also triggers auto sync
            updateCountryFilter();

            // Clear form
            document.getElementById('continent').value = '';
            document.getElementById('country').value = '';
            document.getElementById('location').value = '';
            document.getElementById('famous').value = '';
            document.getElementById('links').value = '';
        }

        function toggleCompleted(checkbox, idx) {
            originalData[idx].completed = checkbox.checked;
            renderTable(originalData);
            saveTimetable(); // auto sync
        }

        function deleteRow(idx) {
            if (!confirm('Delete this destination?')) return;
            originalData.splice(idx, 1);
            renderTable(originalData);
            saveTimetable(); // auto sync
            updateCountryFilter();
        }

        function saveTimetable() {
            localStorage.setItem('travelSaveList', JSON.stringify(originalData));
            autoSaveToGitHub();
        }

        function loadTimetable() {
            originalData = JSON.parse(localStorage.getItem('travelSaveList') || '[]');
            renderTable(originalData);
        }

        function renderTable(data) {
            const tableBody = document.getElementById('travelTableBody');
            tableBody.innerHTML = '';
            data.forEach((entry, idx) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" ${entry.completed ? 'checked' : ''} onchange="toggleCompleted(this, ${idx})"></td>
                    <td>${entry.continent}</td>
                    <td>${entry.country}</td>
                    <td>${entry.location}</td>
                    <td>${entry.famous}</td>
                    <td>${entry.links ? `<a href="${entry.links}" target="_blank">Link</a>` : '-'}</td>
                    <td class="actions"><button onclick="deleteRow(${idx})">Delete</button></td>
                `;
                if (entry.completed) {
                    row.style.textDecoration = 'line-through';
                }
                tableBody.appendChild(row);
            });
        }

        function updateCountryFilter() {
            const countryFilter = document.getElementById('countryFilter');
            const countries = [...new Set(originalData.map(entry => entry.country))].sort();
            countryFilter.innerHTML = '<option value="">All Countries</option>';
            countries.forEach(country => {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countryFilter.appendChild(option);
            });
        }

        function filterByCountry() {
            const countryFilter = document.getElementById('countryFilter').value;
            if (!countryFilter) {
                renderTable(originalData);
            } else {
                const filteredData = originalData.filter(entry => entry.country === countryFilter);
                renderTable(filteredData);
            }
        }

        function sortTable(columnIndex, type) {
            const key = ['completed', 'continent', 'country', 'location', 'famous'][columnIndex];
            sortDirection[key] = !sortDirection[key];
            const sortedData = originalData.slice().sort((a, b) => {
                let valA = type === 'checkbox' ? a[key] : a[key].toLowerCase();
                let valB = type === 'checkbox' ? b[key] : b[key].toLowerCase();
                if (type === 'checkbox') {
                    return sortDirection[key] ? (valA === valB ? 0 : valA ? -1 : 1) : (valA === valB ? 0 : valB ? -1 : 1);
                }
                return sortDirection[key] ? valA.localeCompare(valB) : valB.localeCompare(valA);
            });
            renderTable(sortedData);
        }

        function clearTimetable() {
            if (confirm('Are you sure you want to clear the entire travel list?')) {
                originalData = [];
                renderTable(originalData);
                localStorage.removeItem('travelSaveList');
                autoSaveToGitHub();
                updateCountryFilter();
            }
        }

        // ---- Export/Import ----
        function exportToFile() {
            const data = localStorage.getItem('travelSaveList');
            const blob = new Blob([data], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "travel-save-list.json";
            a.click();
            URL.revokeObjectURL(url);
        }
        function importFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    originalData = JSON.parse(e.target.result);
                    renderTable(originalData);
                    saveTimetable();
                    updateCountryFilter();
                    alert('Imported successfully!');
                } catch {
                    alert('Import failed. Check your file format.');
                }
            };
            reader.readAsText(file);
        }

        // Expose some functions for inline event handlers
        window.addEntry = addEntry;
        window.toggleCompleted = toggleCompleted;
        window.deleteRow = deleteRow;
        window.sortTable = sortTable;
        window.exportToFile = exportToFile;
        window.importFromFile = importFromFile;
        window.filterByCountry = filterByCountry;
        window.clearTimetable = clearTimetable;
        window.setToken = setToken;
        window.removeToken = removeToken;
    </script>
</body>
</html>